machine:
  pre:
    - curl https://raw.githubusercontent.com/creationix/nvm/v0.23.3/install.sh | bash
  services:
    - docker
  node:
    version: iojs-3.0.0
dependencies:
  pre:
    - docker pull cockroachdb/cockroach:alpha-3156-ge7385d9
    - docker run -p 8080:8080 -v /data cockroachdb/cockroach:alpha-3156-ge7385d9 init --stores=ssd=/data
    - docker run -p 8080:8080 -d --volumes-from=$(docker ps -q -n 1) cockroachdb/cockroach:alpha-3156-ge7385d9 start --stores=ssd=/data --gossip=self= --insecure
    - docker build -t quay.io/ripple/five-bells-ledger .
test:
  override:
    # Run lint
    - npm run lint
    # Run tests with coverage
    - docker run --name=ledger-test -it --net=host -v /usr/src/app/coverage quay.io/ripple/five-bells-ledger npm test --coverage -- -R spec-xunit-file
    # Extract test artifacts (results and coverage data)
    - docker cp ledger-test:/usr/src/app/xunit.xml ${CIRCLE_TEST_REPORTS}/mocha.xml
    - docker cp ledger-test:/usr/src/app/coverage .
deployment:
  production:
    branch: master
    commands:
      # Upload coverage data
      - docker run --volumes-from ledger-test -e COVERALLS_TOKEN=${COVERALLS_TOKEN} quay.io/ripple/five-bells-ledger npm run coveralls
      # Push NPM package if not yet published
      - mv npmrc-env .npmrc
      - if [ -z "$(npm info $(npm ls --depth=-1 2>/dev/null | head -1 | cut -f 1 -d " ") 2>/dev/null)" ] ; then npm publish ; fi
      # Push Docker image tagged with commit ID
      - sed "s/<AUTH>/${QUAY_TOKEN}/" < "dockercfg-template" > ~/.dockercfg
      - docker tag quay.io/ripple/five-bells-ledger:latest quay.io/ripple/five-bells-ledger:${CIRCLE_SHA1}
      - docker push quay.io/ripple/five-bells-ledger:latest
      - docker push quay.io/ripple/five-bells-ledger:${CIRCLE_SHA1}
      # Push Docker image for tag (if latest commit is tagged)
      - TAG=$(git tag --contains master) ; if [ -n "${TAG}" ] ; then docker tag quay.io/ripple/five-bells-ledger:latest quay.io/ripple/five-bells-ledger:${TAG} ; docker push quay.io/ripple/five-bells-ledger:${TAG} ; fi
general:
  artifacts:
    - "coverage/lcov-report"
