machine:
  services:
    - docker
    - mysql
  node:
    version: 4.0.0
dependencies:
  pre:
    # Build container
    - docker build -t quay.io/ripple/five-bells-ledger .
test:
  override:
    # Run lint
    - npm run lint
    # Run tests with coverage
    - docker run --name=ledger-test -it --net=host -e LEDGER_DB_URI=mysql://ubuntu@localhost/circle_test -v /usr/src/app/coverage quay.io/ripple/five-bells-ledger sh -c 'npm run migrate ; npm test --coverage -- -R spec-xunit-file'
    # Extract test artifacts (results and coverage data)
    - docker cp ledger-test:/usr/src/app/xunit.xml ${CIRCLE_TEST_REPORTS}/
    - docker cp ledger-test:/usr/src/app/coverage .
deployment:
  production:
    branch: master
    commands:
      # Upload coverage data
      - docker run --volumes-from ledger-test -e COVERALLS_TOKEN=${COVERALLS_TOKEN} quay.io/ripple/five-bells-ledger npm run coveralls
      # Push NPM package if not yet published
      - mv npmrc-env .npmrc
      - if [ -z "$(npm info $(npm ls --depth=-1 2>/dev/null | head -1 | cut -f 1 -d " ") 2>/dev/null)" ] ; then npm publish ; fi
      # Push Docker image tagged latest and tagged with commit descriptor
      - sed "s/<AUTH>/${QUAY_TOKEN}/" < "dockercfg-template" > ~/.dockercfg
      - docker tag quay.io/ripple/five-bells-ledger:latest quay.io/ripple/five-bells-ledger:$(git describe)
      - docker push quay.io/ripple/five-bells-ledger:latest
      - docker push quay.io/ripple/five-bells-ledger:$(git describe)
general:
  artifacts:
    - "coverage/lcov-report"
